<!DOCTYPE html>
<html>
  <head>
    <title>ESP32-CAM Remote Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
      #videoContainer {
        max-width: 400px;
        margin: 0 auto;
      }
      #status {
        color: #666;
        text-align: center;
      }
      canvas {
        width: 100%;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div id="videoContainer">
      <canvas id="videoCanvas"></canvas>
      <p id="status">Conectando...</p>
      <button id="reconnectButton" style="display: none">Reconectar</button>
    </div>

    <script>
      const client = mqtt.connect("wss://broker.hivemq.com:8884", {
        clientId: "viewer_" + Math.random().toString(16).substr(2, 8),
        protocol: "wss",
        keepalive: 30,
        connectTimeout: 10000,
        reconnectPeriod: 2000,
        clean: true,
        qos: 0,
        rejectUnauthorized: false,
        will: {
          topic: "esp32cam/stream/status",
          payload: "Viewer disconnected",
          qos: 0,
          retain: false,
        },
      });

      const canvas = document.getElementById("videoCanvas");
      const ctx = canvas.getContext("2d");
      const status = document.getElementById("status");
      const reconnectButton = document.getElementById("reconnectButton");

      let currentFrame = [];
      let expectedChunks = 0;
      let receivedChunks = 0;
      let deviceId = null;

      let connectionTimeout = setTimeout(() => {
        if (!client.connected) {
          status.textContent = "Timeout de conexión. Reintentando...";
          client.end(true);
          location.reload();
        }
      }, 15000);

      console.log("Intentando conectar a MQTT...");

      client.on("connect", () => {
        clearTimeout(connectionTimeout);
        console.log("Conectado al broker MQTT");
        console.log("Client ID:", client.options.clientId);
        console.log("Broker URL:", client.options.hostname);
        status.textContent = "Conectado al broker MQTT, esperando stream...";

        const topics = [
          "esp32cam/stream/#",
          "esp32cam/+/metadata",
          "esp32cam/+/frame/#",
        ];

        topics.forEach((topic) => {
          client.subscribe(topic, { qos: 0 }, (err) => {
            if (err) {
              console.error("Error al suscribirse a " + topic + ":", err);
              status.textContent = "Error al suscribirse: " + err.message;
            } else {
              console.log("Suscrito a:", topic);
            }
          });
        });
      });

      reconnectButton.addEventListener("click", () => {
        status.textContent = "Reconectando manualmente...";
        client.end(true);
        location.reload();
      });

      client.on("close", () => {
        console.log("Desconectado del broker MQTT");
        status.textContent = "Desconectado del broker MQTT. Reconectando...";
        reconnectButton.style.display = "block";
      });

      client.on("message", (topic, message) => {
        console.log(`Mensaje en ${topic} (${message.length} bytes)`);

        try {
          if (topic.endsWith("/metadata")) {
            const metadata = JSON.parse(message.toString());
            console.log("Metadata recibida:", metadata);
            deviceId = metadata.deviceId;
            expectedChunks = metadata.chunks;
            currentFrame = new Array(expectedChunks).fill(null);
            receivedChunks = 0;
            status.textContent = `Recibiendo frame (0/${expectedChunks} chunks)`;
          } else if (topic.includes("/frame/")) {
            const frameIndex = parseInt(topic.split("/").pop());
            currentFrame[frameIndex] = message;
            receivedChunks++;
            status.textContent = `Recibiendo frame (${receivedChunks}/${expectedChunks} chunks)`;

            if (receivedChunks === expectedChunks) {
              try {
                const fullFrame = new Uint8Array(
                  currentFrame.reduce((acc, chunk) => acc + chunk.length, 0)
                );
                let offset = 0;
                currentFrame.forEach((chunk) => {
                  if (chunk) {
                    fullFrame.set(chunk, offset);
                    offset += chunk.length;
                  }
                });

                const blob = new Blob([fullFrame], { type: "image/jpeg" });
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                  canvas.width = img.width;
                  canvas.height = img.height;
                  ctx.drawImage(img, 0, 0);
                  URL.revokeObjectURL(url);
                  status.textContent = "Frame mostrado correctamente";
                };
                img.onerror = (err) => {
                  console.error("Error al cargar la imagen:", err);
                  status.textContent = "Error al mostrar el frame";
                };
                img.src = url;
              } catch (err) {
                console.error("Error procesando frame:", err);
              }
            }
          }
        } catch (error) {
          console.error("Error procesando mensaje:", error);
        }
      });

      client.on("error", (error) => {
        console.error("Error MQTT:", error);
        status.textContent = `Error de conexión: ${error.message}. Reintentando...`;
        setTimeout(() => {
          if (!client.connected) {
            location.reload();
          }
        }, 5000);
      });

      client.on("offline", () => {
        console.log("Conexión perdida, intentando reconectar...");
        status.textContent = "Conexión perdida. Reconectando...";
        reconnectButton.style.display = "block";
      });

      client.on("reconnect", () => {
        console.log("Intentando reconexión MQTT...");
        status.textContent = "Reconectando al servidor...";
      });
    </script>
  </body>
</html>
